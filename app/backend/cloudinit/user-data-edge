#cloud-config
hostname: "{{hostname}}"
users:
  - name: ubuntu
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDsw7jfa7NrKmlCOIlbZ+cdHMucr+qp4yFm+7hLYMj43j/bPaMxY3LVGrVIvUXtaUCMGOSmyGZVF5sBiDPhXQmNpKAjr+yCJjvUYWusj8T1dLBT30hvihUrA0hrSc/LHTRfiEGcRCjiLkA3MGeTeYDo5Eof6tFzF+I5/YFKZGOCeCRJ51LzNxeiQC7/SIHMnMraRtVZhq7P3FPQosAUekFY4QOreGmxpgmCjNdvqf2vAplVCQS+pS3+FjuDlXQ8fOECMwTycoLCVIsVQpTOtAWXAzRhuLM0TvVBiW/r+BeRj2juFPeEowSchSY+JAxZR/0mW8A5Lx8bvUbg28ZKUh58orNBot9TxBAhApIZPh1ml63fCBVdl1Sc4KqdRREA8POj//KynDO6xFbHlPFUuUGIO6Lg7+hVtyGyTwU4dwK6sjXkezv6jV3Ou80zcBE6v345rLU4pYmAxTtx2IDGWY97/yfZwTA/hSFdHIbd1zp3DV7vagRjlgCG/ERRNjhYtMM= ubuntu@livm0001002rsxx

chpasswd:
  list: |
    ubuntu:bonjour
  expire: False

package_update: true
packages:
  - python3-pip

runcmd:
  - curl -sfL https://get.k3s.io | {{k3scmd}}
  - chmod +x start.sh && ./start.sh

write_files:

  - path: /home/ubuntu start.sh
    content: |
      pip install flask
      pip install subprocess
       pip install requests
      python3 deployer_agent.py
    append: true

  - path: /home/ubuntu deployer_agent.py
    content: |
      import subprocess
      from flask import Flask, request,jsonify
      import requests

      app = Flask(__name__)

      @app.route("/")
      def index():
          return jsonify({"bonjour":"hello"})
    append: true
  
