#cloud-config
hostname: "{{hostname}}"
users:
  - name: ubuntu
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDsw7jfa7NrKmlCOIlbZ+cdHMucr+qp4yFm+7hLYMj43j/bPaMxY3LVGrVIvUXtaUCMGOSmyGZVF5sBiDPhXQmNpKAjr+yCJjvUYWusj8T1dLBT30hvihUrA0hrSc/LHTRfiEGcRCjiLkA3MGeTeYDo5Eof6tFzF+I5/YFKZGOCeCRJ51LzNxeiQC7/SIHMnMraRtVZhq7P3FPQosAUekFY4QOreGmxpgmCjNdvqf2vAplVCQS+pS3+FjuDlXQ8fOECMwTycoLCVIsVQpTOtAWXAzRhuLM0TvVBiW/r+BeRj2juFPeEowSchSY+JAxZR/0mW8A5Lx8bvUbg28ZKUh58orNBot9TxBAhApIZPh1ml63fCBVdl1Sc4KqdRREA8POj//KynDO6xFbHlPFUuUGIO6Lg7+hVtyGyTwU4dwK6sjXkezv6jV3Ou80zcBE6v345rLU4pYmAxTtx2IDGWY97/yfZwTA/hSFdHIbd1zp3DV7vagRjlgCG/ERRNjhYtMM= ubuntu@livm0001002rsxx

chpasswd:
  list: |
    ubuntu:bonjour
  expire: False

ntp:
  enabled: true
  servers:
    - ntp.ubuntu.com
    - 0.pool.ntp.org
    - 1.pool.ntp.org

package_update: true


runcmd:
  - ntpdate -u ntp.ubuntu.com || true
  - timedatectl set-ntp true
  - systemctl restart systemd-timesyncd
  - sleep 10
  - curl -sfL https://get.k3s.io | {{k3scmd}}
  - su - ubuntu -c "bash /home/ubuntu/start.sh"

write_files:

  - path: /home/ubuntu/start.sh
    permissions: '0755'
    content: |
      apt satisfy -y python3-pip
      apt install -y python3-pip
      pip install flask
      pip install requests
      nohup python3 deployer_agent.py > log.txt 2>&1 &
    append: true

  - path: /home/ubuntu/deployer_agent.py
    content: |
      import subprocess
      from flask import Flask, request,jsonify
      import requests

      app = Flask(__name__)

      @app.route("/")
      def index():
          return jsonify({"bonjour":"hello"})
      app.run(host="0.0.0.0")
    append: true
  
